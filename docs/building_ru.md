# Поддерживаемые платформы

Код должен одинаково хорошо работать на Windows и Linux без изменений.

Однако скрипты для сборки сейчас не поддерживают Linux. Для сборки под Linux их придется корректировать.

Сейчас налажена сборка только под Windows x64.

# Сборка под Windows

## Необходимые инструменты

### Компилятор

Рекомендуется использовать Clang 8. GCC 8.x и 9.x скорее всего тоже можно использовать, но GCC работает намного медленнее. MSVC не подойдет.

### Линковщик

Желательно использовать Clang'овский LLD. Обычный GNU LD подойдет, хотя он медленнее.

### Make

Для запуска скриптов сборки нужен GNU Make.

## Установка инструментов

**Устанавливаем MSYS2**

MSYS2 - это linux-подобное окружение для Windows. По сути это bash-терминал, вместе с пакетным менеджером, в котором можно найти Windows-порты всех основных инструментов командной строки Linux, некоторые библиотеки и компиляторы.

Все необходимые нам инструменты есть среди пакетов MSYS2.

Установка MSYS2:

* Скачиваем установщик с http://msys2.org и запускаем его. Рекомендуется выбрать путь, содержащий только ASCII-символы, без пробелов.

* Запускаем `mingw64.exe`, чтобы открыть терминал.

* Обновляем пакеты.
  Делаем `pacman -Syu`. В какой-то момент MSYS2 попросить перезапустить его. Закрываем окно, снова запускаем `mingw64.exe`. Делаем `pacman -Su` чтобы обновить оставшиеся пакеты.

Время от времени стоит запускать `pacman -Syuu` для обновления всех установленных пакетов. Если MSYS2 просит перезапустить себя, после этого нужно снова делать `pacman -Syuu`.

Поиск по пакетам выполняется командой `pacman -Ss `_**`строка`**_.

Установить пакеты можно командой `pacman -S `_**`пакеты`**_.

Удалить - командой `pacman -S `_**`пакеты`**_.

Почистить кэш пакетов (удалить установочные архивы пакетов, просто так занимающие место на диске) можно с помощью `pacman -Scc`.

**Устанавливаем необходимые пакеты**

Чтобы поставить все необходимое, запускаем в MSYS2 следующую команду:

`pacman -S mingw-w64-x86_64-clang mingw-w64-x86_64-gdb mingw-w64-x86_64-lld make mingw-w64-x86_64-make`.

Для проверки запускаем `clang++ --version`. Если MSYS2 не может найти `clang++`, то скорее всего проблема в том, что терминал был открыт не так, как нужно - не через `mingw64.exe`, а как-то еще. После перезапуска терминала правильным способом переустанавливать пакеты нет необходимости.

**Патчим баги**

В libstdc++ (реализации стандартной библиотеки C++), которая поставляется с GCC 9.1 (последняя версия на данный момент), есть баг, который не дает использовать ее с Clang'ом. Нужно кое-что пропатчить, чтобы исправить это.

Если `g++ --version` сообщает какую-то другую версию (не 9.1.0), то ничего делать не нужно.

Открываем файл `msys2/mingw64/include/c++/9.1.0/variant`. Находим строку `1559`. Меняем ее с
```cpp
friend constexpr decltype(auto) __detail::__variant::__get(_Vp&& __v);
```
на
```cpp
friend constexpr decltype(auto) __detail::__variant::__get(_Vp&& __v) noexcept;
```

## Сборка

Сборочные скрипты будем запускать с помощью `mingw32-make`. (В терминале MSYS2 можно использовать просто `make`.)

Если планируется собирать не из терминала MSYS2, а из классического терминала Windows или откуда-то еще, то нужно добавить в `PATH` путь до компилятора (`.../msys2/mingw64/bin`).

Сборка запускается из папки с репозиторием командой `mingw32-make mode=debug -j4`.

* `-j4` - в сколько потоков собирать.
* `mode=debug` - режим сборки. Можно также использовать `=release`.

  Полный список режимов можно получить, специально указав неправильный режим, вроде `mode=?`.

  Последний использованный режим сохраняется, в следующий раз его можно не указывать.

Временные файлы, созданные при сборке, сохраняются в `obj/`. Собранный исполняемый файл помещается в `bin/`.

### Настройка сборки

В `Makefile` - основном мейкфайле - нет никаких настраиваемых параметров. В комметариях в начале этого файла подробно описаны флаги командной строки, которые этот скрипт поддерживает.

Флаги компилятора, списки файлов с исходным кодом и библиотек задаются в `project_config.mk`. Там же определяются режимы сборки.

Пути к компилятору и другим программам задаются в `.local_config.mk`. Если компилятор добавлен в `PATH`, то обычно этот файл модифицировать не требуется.

### Используемые библиотеки

Прямо в репозитории есть все необходимые файлы библиотек для компиляции под Windows x64 на MinGW GCC или Clang (платформа `x86_64-w64-mingw32`, она же `x86_64-w64-windows-gnu`).

Следующие библиотеки хранятся в репозитории в виде исходного кода и собираются как часть проекта. Они расположены в `lib/` и `lib/include/`.

* ImGui
* stb_image
* stb_image_write
* stb_rect_pack
* GLFL

Следующие библиотеки используются в уже скомпилированном виде. В репозитории они хранятся скомпилированными для конкретной платформы, указанной выше, в папках `lib/x86_64-w64-mingw32/`, `lib/x86_64-w64-mingw32/include/` и (частично) `bin/`.

При компиляции под другую платформу, эти библиотеки придется пересобирать или искать заранее собранные.

* SDL2
* fmt
* freetype
* zlib

Следующие файлы являются частью стандартной библиотеки, поставляемой вместе с MinGW GCC. Они поставляются вместе с компилятором, и хранятся в репозитории только для удобства. Версии, хранящиеся в репозитории должны всегда поддерживаться в актуальном состоянии.

Если вы компилируете под Windows, но не под x86_64, то их нужно заменить на те версии, которые поставляются с вашим компилятором. Если вы компилируете под Linux, то они не нужны.

* `bin/libgcc_s_seh-1.dll`
* `bin/libstdc++-6.dll`
* `bin/libwinpthread-1.dll`

Остальные `.dll` в `bin/` относятся к предыдущей категории.
